# 开发日志记录 第一阶段 2020 年 7 月 7 日-8 月 10 日

## 2020 年 8 月 6 日

### 工作进展

-   杨宇华

    > 昨晚和小龙师兄对接项目进展，打算本周六去市民之家实地测试，并想出可以缩小 canvas 来临时解决安卓端的问题

    > 修改市民之家的代码，打算明天设置几个蓝牙点进行调试

*   陈通

    > 添加了同时显示指定两个楼层的函数

    > 在安卓机上使用 touchStart 函数代替 touchTap 函数

    > 继续进行了一些测试

-   袁巡

    > 为了使得安卓手机能够使用，采用了缩小 canvas 画布大小的办法，使用两份 wxss，在检测到安卓或 ios 机型时自动切换

    > 调试安卓版本，发现安卓版本 touchTap 点击事件无效，故采用 touchStart 代替，存在误触和部分机型点击不准的问题

    > 楼层切换进行改写，当两个点在同一楼层时只显示一层，不同楼层时只显示两层，当不显示全部楼层时可以提升性能

---

## 2020 年 8 月 5 日

### 工作进展

-   杨宇华

    > 给二楼和三楼设置了新的蓝牙点，测试楼梯和转角处的效果

    > 迁移了市民之家的代码，修改了部分参数，显示正常

*   陈通

    > 修复了初始加载的白屏问题

    > 布置了更多的蓝牙点并进行测试

-   袁巡

    > 解决了初始加载的时候，白屏的问题，结束导航的时候图标不返回的问题

    > 布置了更多的蓝牙测试点，测试多楼层之间的真实导航，调整一些参数

    > 为代码添加注释，在函数内部加入更加详细的注释，方便阅读

---

## 2020 年 8 月 4 日

### 工作进展

-   杨宇华

    > 设置了 ibeacon 模拟测试点，进行测试

    > 添加了根据楼梯口蓝牙判断楼层的功能

*   陈通

    > 在楼道中进行 ibeacon 布点，进行实际测试

    > 调整了 ibeacon 设备的参数，使其更好地进行定位

    > 对导航中图标的移动添加了一些限制和修正

-   袁巡

    > 上午在南一楼布点测试，解决了沿着图标朝向，往前进行移动的问题

    > 调整蓝牙信标的强度和位置，基本解决了蓝牙同层跳动的问题，但还是存在蓝牙不同层跳动的问题

    > 添加了跟随视角，使得真实导航时，视角会随着图标移动而变化，又检测出来了白屏 bug

---

## 2020 年 8 月 3 日

### 工作进展

-   杨宇华

    > 在实验室模拟真实导航，配置相应的 ibeacon，并尝试调参

    > 对小程序的一些数据进行优化，比如将 json 数据进行缓存,尚有问题

*   陈通

    > 学习了如何设置 ibeacon 设备的相关参数和配套软件使用

    > 解决了蓝牙定位不准的问题

    > 正在解决用户位置随步数改变进行移动的问题

-   袁巡

    > 在实验室实地布置蓝牙信标，调试跟随蓝牙变化移动的问题，下午终于解决

    > 为开始导航添加逻辑和动画，使得沿着路径可以同时真实移动

    > 将步数检测加入到了模拟导航中，还存在灵敏度问题

---

## 2020 年 7 月 31 日

### 工作进展

-   杨宇华

    > 调整了页面代码，尝试取消小程序上拉事件

    > 尝试使用 ibeacon 进行测试，设置了三个点，初步测试可行，但操作不够方便

    > 找曹智峰，修改了 json 数据，方便进行测试

    > **BeaconSET 可以修改 ibeacon 设备，初始密码 minew123，备用密码 99fdbl20**

*   陈通

    > 添加了回到当前位置时相机自动跟随当前用户朝向的功能

    > 修复了选择目的地时如果只显示当前层规划路径会显示不全的问题

    > 研究了 ibeacon 设备的参数设置和对应的软件

-   袁巡

    > 参加了上午会议，了解了项目后端的情况和后端更改框架的情况

    > 修复了小程序，初次点击设为起点时不对应文本和点击去到这里时不对应文本的情况

    > 和成亮师兄通话，了解了真实导航的实现过程，并开始设置 ibeacon 进行实验室测试

---

## 2020 年 7 月 30 日

### 工作进展

-   杨宇华

    > 完成 compass，实现指北针，导入阿里图标库，并更换了页面图标

    > 通过 compass 获取当前用户的朝向，并实时改变地图上的当前标识的朝向

*   陈通

    > 删除了不必要的代码并进行重构

    > 小组三个人一起修复了诸多 BUG

-   袁巡

    > 实现了蓝牙实时刷新，确定用户当前的位置，并将贴图跟随蓝牙位置进行舒心

    > 将很多 js 文件当中的公用方法和重复函数提取出来，放入 util 文件当中，减少了不必要代码，方便其他所有文件调用

    > 小组三个人协同编程，解决修复程序 bug

---

## 2020 年 7 月 29 日

### 工作进展

-   杨宇华

    > 完成了 GPS 的相关 API 编写，并在校园内模拟了 GPS 定位，应该没问题

    > 增加了 compass 罗盘，可以获取当前的经纬度信息，并尝试实现罗盘旋转

*   陈通

    > 解决了模拟导航中相机视角移动的问题

    > 修复了相机移动时动画抖动的问题

-   袁巡

    > 解决了模拟导航中视角跟随路径的问题，并调整了 3d 视角

    > 增加了到这里去，以及切换终点和起点两个按钮绑定的效果

    > 发现了在模拟导航结束后，通过搜索点击选中位置出现的 bug，还未解决

---

## 2020 年 7 月 28 日

### 工作进展

-   杨宇华

    > 编写 gps 相关函数，进行了封装，并结合数据进行测试

    > 找出 tts 不能播放语音的问题，playbackRate 属性不能使用

*   陈通

    > 解决了移动相机注视点后画面只刷新一次的问题

    > 实现了在任何位置返回当前位置的方法

    > 实现了在任意两点间移动相机的接口

-   袁巡

    > 解决了在路径导航过程中，同步在上方提示栏当中加入当前移动方向提示语的功能

    > 使得管状的路径可以不停滚动，规范了开始和结束导航时的页面切换，为文字添加了语音

    > 研究了相机的 target,为下一部分添加导航的视角切换作准备

---

## 2020 年 7 月 27 日

### 工作进展

-   杨宇华

    > 完成了副页面的设计和编写，相应的功能也添加了上去

    > 研究 three.js 的 demo，了解源码中是如何控制相机移动

*   陈通

    > 将文字精灵和图片精灵加载的方法分离，重写了图片精灵加载的方法

    > 研究了相机的参数，需要对回到起点的函数进行参数更新

    > 碰巧帮袁巡解决了动画无法连续加载的问题

*   袁巡

    > 研究 tween.js 的很多 demo，学习动画的写法

    > 解决了动画连续，两次运动接续的问题，之后就可以实现导航路径上连续移动

    > 解决了导航路径上移动时，箭头方向跟随变化问题

---

## 2020 年 7 月 24 日

### 工作进展

-   杨宇华

    > 继续编写副页面，先完成了数据格式化，后制作了楼层选择抽屉，并增加了一些动画

    > 发现了页面上组件不现实的原因——css 中设置了 opacity 属性，这应该是小程序的一个 bug

*   陈通

    > 解决了精灵加载的堆栈溢出问题和性能问题

    > 将精灵加载部分分离出一个单独的文件并进行重构，删除了不必要的部分并添加了注释

*   袁巡

    > 上午完成了软件工程 ppt 的汇报

    > 开始研究 tween 动画，加载模拟导航的效果，已经可以实现从当前位置跳转到导航起点的动画，但是目前由于尚未弄清楚的遮挡问题，导致 user 图标被其他物体遮挡，需要继续研究

---

## 2020 年 7 月 23 日

### 工作进展

-   杨宇华

    > 继续编写文档添加了部分模块的介绍以及附录内容

    > 完成了副页面搜索框的相关功能，包括实时搜索、显示、点击等事件

*   陈通

    > 编写技术文档中地图加载和相机切换两部分的内容

    > 解决了多次创建纹理对象的问题

    > 继续优化加载精灵的函数实现

*   袁巡

    > 继续整理软件工程相关内容，完成汇报时使用 ppt 熟练汇报流程

    > 研究系统详细设计说明书，开始编写定位模块和步数监测模块文档

---

## 2020 年 7 月 22 日

### 工作进展

-   杨宇华

    > 编写智慧标识导航系统微信小程序改版项目技术文档

    > 完成了前 1-5 节、7 节和 9 节的编写

*   陈通

    > 修复了地图上半屏无法点击的问题

    > 添加了返回当前位置的响应事件

    > 尝试了多种清除 threejs 缓存的方法，但暂时没能成功

*   袁巡

    > 整理代码，处理 bug，为代码中的函数添加注释，增加可读性

    > 回顾软件工程内容，编写汇报时展示的 ppt

---

## 2020 年 7 月 21 日

### 工作进展

-   杨宇华

    > 新增了 img 文件夹，暂时本地存放图片文件，如果大小不超，可以提高小程序性能

    > 制作当前工作进度的 PPT 并讲解

    > 当晚开会，小龙师兄一一答复了当前项目中的问题，已更新在需求说明书中

*   陈通

    > 修复了模型显示与旋转手势的冲突问题

    > 调整了页面元素布局

    > 录制了展示用的演示视频

*   袁巡

    > 解决了在初次点击起点和终点的时候，页面不会刷新改变的问题

    > 正在处理添加模拟导航的动画，研究源代码的逻辑操作

---

## 2020 年 7 月 20 日

### 工作进展

-   杨宇华

    > 再次研究了 orbit 源码，加深了理解

    > 再次尝试 2D 转 3D，尝试复用源码，但没能成功

    > 增加了搜索栏的数据格式化函数

*   陈通

    > 阅读并分析了需求文档

    > 修复了贴图精灵点击和显示的一些细节问题

    > 阅读相机控制中视角切换和自动跟踪的部分

*   袁巡

    > 实现了点击任意两个位置，确定终点和起点，画出贴图在地图上

    > 将 astar 算法运用在动态的起点和终点上，使得只要选择了起点和终点就可以绘制出最短路径的导航路线

    > 添加了一些点击切换绑定，使得 UI 和文字可以和起点和终点的切换同时更新

---

## 2020 年 7 月 17 日

### 工作进展

-   杨宇华

    > 添加搜索的模态框，完成了部分布局，暂时不采用跳转到第二页面的想法

    > 完成了技术文档初稿

    > 编写当前项目分工、进展、存在问题的文档

*   陈通

    > 实现了将屏幕坐标转换为世界坐标系下的坐标并在相应位置显示图标的方法

    > 添加了显示特定楼层和显示所有楼层的响应事件

    > 实现了获取离特定世界坐标最近的地点并显示在前端界面的方法

*   袁巡

    > 将导航方法绑定到模拟导航按钮上，开始处理模拟导航的逻辑过程

    > 将起点和终点贴图，显示在地图上的固定的节点位置

    > 添加起点和终点之间的连线，模拟导航的过程，但遇到一些问题，比如管状路线颜色不对，以及无限增加的 warning

---

## 2020 年 7 月 16 日

### 工作进展

-   杨宇华

    > 研究 orbit.js 的源码，封装了一些属性提供了修改功能

    > 正在尝试 2D 和 3D 的视角切换，3D 转 2D 容易实现，反过来还在探索

    > 修改技术文档，添加了主要函数和技术介绍

*   陈通

    > 实现了点击屏幕任意位置获取相应屏幕坐标的方法

    > 更新了加载模型的方法，可以将所有模型全部加载进来，同时将其单独抽象为一个函数

    > 正在探索如何将屏幕坐标转换为世界坐标系下的坐标并在相应位置显示图标的方法

*   袁巡

    > 在实现用户贴图的基础之上，开始增加用户移动动画

    > 将用户贴图移动和之前的加速度测量的步数监测相结合，实现移动事实时移动

    > 下一步研究模拟导航，使得用户贴图真正可以沿着指定的轨迹进行移动

---

## 2020 年 7 月 15 日

### 工作进展

-   杨宇华

    > 解决了昨天 main.js 引入文件的问题，调整了模型的显示位置

    > 研究了手势控制，发现 orbit.js 文件中已经集成了两套手势方案，选择 map 即可

    > 修改了 orbit.js 的源码，调整了模型的最大最小缩放比例和旋转程度

*   陈通

    > 解决了精灵纹理无法正常显示的问题

    > 通过使用 canvas 转图片的方式让文字精灵和图片精灵得以正常显示

    > 继续阅读点击地图任意一点显示相应提示的代码部分

*   袁巡

    > 实现了监听加速度变化，并通过加速度波峰变化来测算步数，可以在屏幕上显示实时步数

    > 再次学习 model.js 里的写法，搞清楚 threejs 逻辑

    > 往场景当中加入了用户贴图

---

## 2020 年 7 月 14 日

### 工作进展

-   杨宇华

    > 增加 tts.js 合成语音的接口，并研究了下 import export 和 module.exports require 之间的区别

    > 修改了技术文档

    > 和大家讨论，决定增加 main.js，进一步封装，优化代码结构

*   陈通

    > 阅读了实现精灵的源码，弄清楚了各函数之间的调用关系

    > 实现了批量创建精灵的方法，并使用一个 THREE.Group 进行暂存

    > 实现了将暂存后的精灵组渲染到界面上的功能，但由于纹理问题暂时不能清晰显示

*   袁巡

    > 完成了蓝牙定位功能，可以通过扫描得到附近的蓝牙信息，来确定一个信号最强的位置作为当前的用户定位

    > 添加了结束蓝牙扫描，实现了蓝牙扫描，使用蓝牙数据计算最终结束的完整流程

    > 研究了 model.js 代码，确定了下一步开发的模块是步数监测部分

---

## 2020 年 7 月 13 日

### 工作进展

-   杨宇华

    > 发现了代码的中的问题——错误地将方法都写在了 data 中，以至于找不到方法而无法调用报错

    > 添加主页面下方的三个组件，并重新设计了这几个组件的 UI

    > 学习了 weui Searchbar 的用法，在搜索页面添加了标题和搜索栏，但由于 UI 未确定，暂时停滞

*   陈通

    > 解决了如何在 index.js 或其他页面中操作 threejs 渲染后的 canvas 中元素的问题，解决方法是使用 getApp()来生成全局变量，通过将其作为参数传入 model.js 文件后使用

    > 更新了 model.js，删除了不必要的部分并添加了注释

    > 实现了 2D 到 3D 视角的切换动画

*   袁巡

    > 完整实现了 astar 算法，并用加数据测试了导航的正确性

    > 开始蓝牙部分功能的书写，使用了半屏模态框，来提醒用户打开蓝牙，完成蓝牙接口的初始化

    > 开始书写，蓝牙的搜索部分，获取蓝牙的信息来进行操作

---

## 2020 年 7 月 10 日

### 工作进展

-   杨宇华

    > **2.12.0 版本正在灰度中**

    > 今天继续编写页面的上方组件，完成了搜索框、“起点终点模块”和“导航提示”的样式和排版，并完成了部分 JS 代码的接口

    > 添加了枫丹白露的 logo，将右侧组件进行了对齐

*   陈通

    > 今天主要在学习微信小程序的结构以及开发流程，下周可以正式开始代码编写

    > 学会了 git 分支冲突如何处理，解决了能够 push 但未显示在 contributors 中的问题

*   袁巡

    > 今天开始了小程序代码书写，完成了从服务获取数据，处理数据的部分

    > 开始了 astar 导航算法的编写，测试了多个 js 的传递参数问题

    > 发现多人协作进行开发，git 仓库会发生冲突，大家一起解决了冲突

---

## 2020 年 7 月 9 日

### 工作进展

-   杨宇华

    > 对整个页面进行布局设计，计算各模块的宽高比例，并设置了自适应宽高

    > 引入 weui 库，并测试成功，完成了前端两个模块的部分功能

    > 组件和 glb 模型存在冲突，**glb 模型所在的 canvas 会覆盖其他组件**，查询了大量的资料发现，微信小程序的 canvas 正在逐步支持同层渲染，**iOS 端已支持，Android 端预计 2.12.0 支持，当前版本 2.11.3**

*   陈通

    > 将 three.js 教程剩下的内容学习完毕

    > 测试了若干开源的微信地图小程序

    > 阅读源代码结构，理清函数调用关系，方便下一步重构代码

*   袁巡

    > 完成了所有源代码的阅读，并更新了思维导图，最新链接如下https://mubu.com/doc/61EcgRgg9qo#

    > 在 WebGL 中文网进行 threejs 的学习，可以加深对于源码的理解

---

## 2020 年 7 月 8 日

### 分工

-   杨宇华负责调试小程序，使其能在手机上正常运行；

-   陈通负责学习和使用 three.js， 使模型能够正常显示；

-   袁巡负责阅读原理，理清函数间的调用关系，方便以后的开发，
    ~~kbone 方案暂时废弃~~

### 工作进展

-   杨宇华

    > 小程序官方称 webGL 和 canva2D 都不能进行真机调试，而只能预览，报错还有可能是因为微信版本和小程序基础库的不支持，在小程序的后台可设置最低支持的版本库;

    > 模型成功在手机上预览，但是较大的模型似乎还不行，具体原因待查明；

    > 整理了文件结构，删除了暂时不需要的文件夹以及文件，方便后续开发。

-   陈通

    > 学习了 WebGL 中文网提供的 three.js 初级教程，对 three.js 的使用有了一个基本了解，包括但不限于基本形状的绘制、3D 模型的加载、物体的移动与旋转、光源和纹理的使用

    > 调整了测试 demo 的部分参数，使得模型能够正常显示，同时听取了刘成亮师兄的意见，通过分层加载的方式将整个楼层加载进小程序，今天尝试了双层并取得成功

-   袁巡

    > 再次阅读源码，完成了 map.js 和 blueLocation.js 的整理，并绘制出了思维导图，链接如下：
    > https://mubu.com/doc/61EcgRgg9qo

    > kbone 方案考虑到没有稳定的 web 版本，并且还要重构成 vue 等框架，所以暂时废弃

---

## 2020 年 7 月 7 日

1、暂时确定不使用云服务器

2、需要确定具体的方案:

-   杨宇华和陈通负责测试直接使用 three.js 在小程序上的可行性；

-   袁巡负责测试 kbone 等其他框架将原网页转换成小程序的可行性;

-   ~~企业号小程序的 web-view 可以直接显示网页，这个方案待定。~~

### 工作进展

-   杨宇华

    > 编写文档《室内定位项目中“不能自己实现蓝牙通讯或者获取蓝牙信息”的原因》

    > 安装小程序版的 three.js，初步测试小程序可以显示 glb 模型，但暂时无法在手机上正常显示，原因待查明

    > 经过调研，企业号小程序的 web-view 可以直接显示网页，但是无法调用蓝牙接口，该方案不可行

-   陈通

    > 测试了若干使用 three.js 的程序 demo，初步了解了如何在微信小程序上使用 three.js，但在进行真机调试时发现了若干问题，需要后面进一步解决

    > 对加载场景元素和 glb 文件的 loader 函数的参数进行了调整测试，初步了解了如何设置参数使模型处于合适的位置，后续需要进一步改进

    > 测试了一些使用 three.js 的微信小游戏，发现大多数是通过对普通 jpg、png 格式的图片使用物理引擎进行渲染，不符合我们的工程需要，另外了解到小游戏的审核较为严格，因此可行性不高

-   袁巡

    > 学习发现 kbone 框架特性和使用方法，发现还需将项目改变成 vue 等框架才能使用 kbone 进行部署

    > 在 kbone 框架 demo 当中测试微信小程序蓝牙接口，发现可行

    > 在 kbone 框架 demo 当中测试微信小程序 threejs 接口，发现可行，但依然存在在手机上无法显示 glb 模型的问题

---
